// SCHEMA FROZEN FOR NOW — don’t add/remove models until first UI is working.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----- Enums -----

enum UserRole {
  OWNER
  ADMIN
  USER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum JobStatus {
  PLANNING
  IN_PROGRESS
  ON_HOLD
  DELIVERED
  ARCHIVED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum JobRole {
  OWNER
  COLLABORATOR
  VIEWER
}

// ----- Models -----

model User {
  id          String           @id @default(cuid())
  email       String           @unique
  name        String?
  password    String?          // Hashed password (null for OAuth users)
  role        UserRole         @default(USER)
  emailVerified DateTime?
  isPaused    Boolean          @default(false) // Admin can pause accounts temporarily
  
  // Profile fields
  phone       String?
  website     String?
  pronouns    String?          // e.g., "he/him", "she/her", "they/them"
  timezone    String?          // e.g., "America/New_York"
  avatar      String?          // URL to avatar image
  
  // Relationships
  jobs        JobCollaborator[]
  tasks       TaskAssignee[]
  comments    Comment[]
  attachments Attachment[]     @relation("UserAttachments")
  invitationsSent Invitation[] @relation("InvitedBy")
  emailVerificationTokens EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]
  notifications Notification[]
  notificationsAsActor Notification[] @relation("NotificationActor")
  teamMemberships UserTeam[]
  activityLogs UserActivity[]
  notificationPreferences UserNotificationPreferences?
}

model Invitation {
  id          String   @id @default(cuid())
  email       String
  token       String   @unique
  role        UserRole @default(USER)
  invitedById String
  invitedBy   User     @relation("InvitedBy", fields: [invitedById], references: [id])
  jobId       String?  // Optional: if set, user will be added as collaborator when accepting
  job         Job?     @relation(fields: [jobId], references: [id])
  status      InvitationStatus @default(PENDING)
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  acceptedAt  DateTime?

  @@index([token])
  @@index([email])
  @@index([status])
}

model Client {
  id         String  @id @default(cuid())
  name       String
  isArchived Boolean @default(false) // Admin can archive clients
  brands     Brand[]
}

model Brand {
  id         String  @id @default(cuid())
  name       String
  clientId   String
  isArchived Boolean @default(false) // Admin can archive brands
  client     Client  @relation(fields: [clientId], references: [id])
  jobs       Job[]
}

model Job {
  id            String           @id @default(cuid())
  jobNumber     String           @unique
  title         String
  status        JobStatus        @default(PLANNING)
  brief         String?
  resourcesUrl  String?
  isArchived    Boolean          @default(false) // Admin can archive jobs

  // Financial tracking (admin-only)
  estimate      Float?           // Estimated cost/project value
  billedAmount  Float?           // Amount billed to client
  paidAmount    Float?           // Amount received from client
  purchaseOrder String?          // Purchase order number

  brandId       String
  brand         Brand            @relation(fields: [brandId], references: [id])

  collaborators JobCollaborator[]
  tasks         Task[]
  attachments   Attachment[]
  comments      Comment[]
  notifications Notification[]
  invitations   Invitation[]
  teamId        String?
  team          Team?   @relation(fields: [teamId], references: [id])
}

model JobCollaborator {
  id       String   @id @default(cuid())
  jobId    String
  userId   String
  role     JobRole  @default(COLLABORATOR)

  job      Job      @relation(fields: [jobId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([jobId, userId])
}

model Task {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      TaskStatus    @default(TODO)
  priority    TaskPriority  @default(MEDIUM)
  dueDate     DateTime?
  // Temporarily commented out until migration runs
  // createdAt   DateTime      @default(now())
  // deletedAt   DateTime?      // Soft delete - when task is deleted

  jobId       String?       // Optional - tasks can exist without a job
  job         Job?          @relation(fields: [jobId], references: [id])

  assignees   TaskAssignee[]
  attachments Attachment[]
  comments    Comment[]
  notifications Notification[]
}

model TaskAssignee {
  id      String @id @default(cuid())
  taskId  String
  userId  String

  task    Task   @relation(fields: [taskId], references: [id])
  user    User   @relation(fields: [userId], references: [id])

  @@unique([taskId, userId])
}

model Attachment {
  id           String   @id @default(cuid())
  jobId        String?
  taskId       String?
  url          String
  filename     String
  mimeType     String
  uploadedById String
  uploadedAt   DateTime @default(now())

  job         Job?      @relation(fields: [jobId], references: [id])
  task        Task?     @relation(fields: [taskId], references: [id])
  uploadedBy  User      @relation("UserAttachments", fields: [uploadedById], references: [id])
}

model Comment {
  id        String   @id @default(cuid())
  body      String
  createdAt DateTime @default(now())

  authorId  String
  author    User     @relation(fields: [authorId], references: [id])

  jobId     String?
  taskId    String?
  job       Job?     @relation(fields: [jobId], references: [id])
  task      Task?    @relation(fields: [taskId], references: [id])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

enum NotificationType {
  TASK_ASSIGNED
  JOB_ASSIGNED
  TASK_COMPLETED
  COMMENT_MENTION
}

enum ActivityType {
  SIGNED_IN
  SIGNED_OUT
  CREATED_TASK
  MARKED_TASK_COMPLETE
  UPLOADED_FILE
  INVITED_COLLABORATOR
  ASSIGNED_JOB
  UPDATED_PROFILE
  CHANGED_PASSWORD
  DELETED_ACCOUNT
}

model Notification {
  id        String          @id @default(cuid())
  type      NotificationType
  read      Boolean         @default(false)
  createdAt DateTime        @default(now())
  userId    String
  taskId    String?
  jobId     String?
  commentId String?
  title     String
  message   String
  actorId   String?

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  task      Task?           @relation(fields: [taskId], references: [id], onDelete: SetNull)
  job       Job?            @relation(fields: [jobId], references: [id], onDelete: SetNull)
  actor     User?           @relation("NotificationActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([taskId])
  @@index([jobId])
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  
  members     UserTeam[]
  jobs        Job[]    // Jobs associated with this team
  
  @@unique([name])
}

model UserTeam {
  id        String   @id @default(cuid())
  userId    String
  teamId    String
  joinedAt  DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
}

model UserActivity {
  id        String       @id @default(cuid())
  userId    String
  type      ActivityType
  details   String?     // JSON string with additional details
  createdAt DateTime     @default(now())
  
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([type])
}

model UserNotificationPreferences {
  id        String   @id @default(cuid())
  userId    String   @unique
  
  // Job assignment notifications
  jobAssignedInApp    Boolean @default(true)
  jobAssignedEmail    Boolean @default(true)
  
  // Comment mention notifications
  commentMentionInApp Boolean @default(true)
  commentMentionEmail Boolean @default(true)
  
  // Job change notifications
  jobChangeInApp      Boolean @default(true)
  jobChangeEmail      Boolean @default(false)
  
  // Task completion notifications
  taskCompleteInApp   Boolean @default(true)
  taskCompleteEmail    Boolean @default(false)
  
  // Task overdue notifications
  taskOverdueInApp    Boolean @default(true)
  taskOverdueEmail    Boolean @default(false)
  
  // Frequency (null = immediate)
  frequency           String? // "immediate", "daily", "weekly"
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}
